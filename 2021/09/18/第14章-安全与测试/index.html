<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"/>





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.0.1"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta property="og:type" content="article">
<meta property="og:title" content="第14章 安全与测试">
<meta property="og:url" content="http://yoursite.com/2021/09/18/%E7%AC%AC14%E7%AB%A0-%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/09/18/%E7%AC%AC14%E7%AB%A0-%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B5%8B%E8%AF%95/1.png">
<meta property="article:published_time" content="2021-09-18T13:17:02.000Z">
<meta property="article:modified_time" content="2024-03-08T03:02:41.734Z">
<meta property="article:author" content="CheBin">
<meta property="article:tag" content="Go语言编程入门与实战技巧">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/09/18/%E7%AC%AC14%E7%AB%A0-%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B5%8B%E8%AF%95/1.png">






  <link rel="canonical" href="http://yoursite.com/2021/09/18/第14章-安全与测试/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>第14章 安全与测试 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<meta name="generator" content="Hexo 7.1.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">微习惯，每天看1分钟</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br/>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br/>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/18/%E7%AC%AC14%E7%AB%A0-%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B5%8B%E8%AF%95/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin"/>
      <meta itemprop="description" content="参与开源才是出路"/>
      <meta itemprop="image" content="/images/avatar.jpg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第14章 安全与测试

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-09-18 21:17:02" itemprop="dateCreated datePublished" datetime="2021-09-18T21:17:02+08:00">2021-09-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2024-03-08 11:02:41" itemprop="dateModified" datetime="2024-03-08T11:02:41+08:00">2024-03-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">60k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">54 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<span id="more"></span>
<h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a><span style="color:#339AFF;">安全</span></h1><p><strong>1，哈希函数</strong></p>
<p>Go语言提供了MD5、SHA-1等几种哈希函数，下面的例子是一个简单的介绍：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/sha1&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    TestString := <span class="string">&quot;Hi,Golang!&quot;</span></span><br><span class="line">    Md5Inst := md5.New()</span><br><span class="line">    Md5Inst.Write([]<span class="type">byte</span>(TestString))</span><br><span class="line">    Result := Md5Inst.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%x\n&quot;</span>, Result)</span><br><span class="line"></span><br><span class="line">    Sha1Inst := sha1.New()</span><br><span class="line">    Sha1Inst.Write([]<span class="type">byte</span>(TestString))</span><br><span class="line">    Result = Sha1Inst.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%x&quot;</span>, Result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">465982b657a9ca520e2e233ef2c6b094</span></span><br><span class="line"><span class="comment">01c858d49ef76be4ef548962e72586c8f222ae9d</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><br>再举一个例子，对文件内容计算SHA1：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/sha1&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fileName := <span class="string">&quot;chapter14/14-1.go&quot;</span></span><br><span class="line">    infile, inerr := os.Open(fileName)</span><br><span class="line">    <span class="keyword">if</span> inerr == <span class="literal">nil</span> &#123;</span><br><span class="line">        md5h := md5.New()</span><br><span class="line">        io.Copy(md5h, infile)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;文件“%s”的md5值为：%x\n&quot;</span>, fileName, md5h.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>)))</span><br><span class="line"></span><br><span class="line">        sha1h := sha1.New()</span><br><span class="line">        io.Copy(sha1h, infile)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;文件“%s”的sha1值为：%x\n&quot;</span>, fileName, sha1.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>)))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(inerr)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">文件“chapter14/14-1.go”的md5值为：c5a77349cb9df296ceee33712a279a37</span></span><br><span class="line"><span class="comment">文件“chapter14/14-1.go”的sha1值为：da39a3ee5e6b4b0d3255bfef95601890afd80709</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2，支持HTTPS的Web服务器</strong></p>
<p>Go语言目前实现了TLS协议的部分功能，已经可以提供最基础的安全层服务。下面来看如何实现支持TLS的Web服务器。如下示例示范了如何使用http.ListenAndServerTLS实现一个支持HTTPS的Web服务器：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ServerPort = <span class="number">8080</span></span><br><span class="line"><span class="keyword">const</span> ServerDomain = <span class="string">&quot;localhost&quot;</span></span><br><span class="line"><span class="keyword">const</span> ResponseTemplate = <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rootHandler</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span>  &#123;</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html&quot;</span>)</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Length&quot;</span>, fmt.Sprint(<span class="built_in">len</span>(ResponseTemplate)))</span><br><span class="line">    w.Write([]<span class="type">byte</span>(ResponseTemplate))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/&quot;</span>, rootHandler)</span><br><span class="line">    http.ListenAndServeTLS(fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, ServerDomain, ServerPort), <span class="string">&quot;some.crt&quot;</span>, <span class="string">&quot;some.key&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这段代码实际上是无法运行的，因为并没有提供相应的证书文件，程序只会直接停止运行。如果一切准备好，运行该服务器程序后，在浏览器中访问<code>localhost:8080</code>可以看到一句“Hello World”。</p>
<p>可以看到代码中使用了<code>http.ListenAndServeTLS()</code>这个方法，这表明它是执行在TLS层上的HTTP协议。相应地，非TLS协议只需要把该方法替换为<code>http.ListenAndServe(fmt.Sprintf(&quot;:%d&quot;, SERVER_PORT),nil)</code>即可。</p>
<p><strong>3，支持HTTPS的文件服务器</strong></p>
<p>利用Go语言标准库中提供的完备封装，也可以很容易地实现一个支持HTTPS的文件服务器，如下面代码所示：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    h := http.FileServer(http.Dir(<span class="string">&quot;.&quot;</span>))</span><br><span class="line">    http.ListenAndServeTLS(<span class="string">&quot;:8001&quot;</span>, <span class="string">&quot;rui.crt&quot;</span>, <span class="string">&quot;rui.key&quot;</span>, h)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这是一个极简的例子，只是单纯介绍了FileServer函数的存在，这个函数的参数只有一个就是根目录路径，其他任务全部由ListenAndServe*等函数完成。</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a><span style="color:#339AFF;">测试</span></h1><p>在计算机编程中，单元测试（Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。程序单元是应用的最小可测试部件，在过程化编程中，一个单元就是单个程序，包括函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类或者派生类（子类）中的方法。</p>
<p>测试的目的自然是确认代码是否正常工作，例如测试代码是否可以成功地向数据库中插入一条记录，这种测试叫作“正向路径”测试，就是在正常执行的情况下，保证代码不产生错误的测试。</p>
<p>另外一种情况是测试代码是否会产生预期的错误，例如程序对数据库进行查询时没有找到任何结果，或者对数据库做了无效的更新，那么应该返回一个可以控制的错误，而不是导致程序崩溃，这种测试即为“负向路径”的测试场景，保证代码不仅会产生错误，而且是预期的错误。</p>
<p>总之，不管如何调用或者执行代码，所写的代码行为都是可预期的测试才算通过。</p>
<p>在Go语言里有几种方法可用于单元测试，基础测试（basic test）是指只使用一组参数和结果来测试一段代码；表组测试（table test）是指使用多组参数和结果测试一段代码。此外，也可以使用一些方法来模仿（mock）测试代码需要使用到的外部资源，如数据库或者网络服务器。例如当外部资源不可用的时候，模拟这些资源的行为可以使测试正常进行。</p>
<p>最后，在构建自己的网络服务时，有几种方法可以在不运行服务的情况下，调用服务的功能进行测试。</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>testing是Go语言的一个package，它提供自动化测试功能。通过<code>go test</code>命令能够自动执行如下形式的函数：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestXxx</span><span class="params">(*testing.T)</span></span></span><br></pre></td></tr></table></figure><br>其中Xxx可以是任何字母、数字、字符串，但是Xxx的第一个字母不能是小写字母。在这些函数中，使用Error、Fail或相关方法来返回失败信号。</p>
<p>要编写一个新的测试模块，需要创建一个名称以<code>_test.go</code>结尾的文件，该文件包含TestXxx函数，最后将该文件放在与被测试的包相同的包目录中。该文件将被排除在正常的程序包之外，但在运行<code>go test</code>命令时将被调用。运行<code>go help test</code>和<code>go help test flag</code>可以了解更加详细的信息。</p>
<p><strong>1，第一个单元测试</strong></p>
<p>要测试的代码如下，下面的Age函数中，如果输入的参数值小于0则返回0，如果输入大于0则返回相应数值：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(Age(<span class="number">-7</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Age</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    &#125;</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>测试代码如下所示，现在测试的是如果输入小于0的数字，程序是否会返回相应的数字0：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAge</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        input    = <span class="number">-100</span></span><br><span class="line">        expected = <span class="number">1</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    actual := Age(input)</span><br><span class="line">    <span class="keyword">if</span> actual != expected &#123;</span><br><span class="line">        t.Errorf(<span class="string">&quot;Fib(%d) = %d, 预期为%d&quot;</span>, input, actual, expected)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>执行测试命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go <span class="built_in">test</span></span></span><br><span class="line">ok      test    0.021s</span><br></pre></td></tr></table></figure><br>这就是基础测试，下面来看表组测试，可以提供多组数据的测试方式。</p>
<p><strong>2，表组测试</strong></p>
<p>测试讲究覆盖率，按上面的方式，当要覆盖更多情况时，显然通过修改代码的方式很笨拙。这时可以采用表组测试的方式写测试代码，标准库中有很多测试是使用这种方式写的。</p>
<p>例如，以下程序的作用是判断一个数字是否是素数：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(isPrime(<span class="number">25</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大于1的自然数中，除了1和它本身以外不再有其他因数的数称为质数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isPrime</span><span class="params">(value <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> value &lt;= <span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value &gt;= <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> value%<span class="number">2</span> == <span class="number">0</span> || value%<span class="number">3</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">5</span>; i*i &lt;= value; i += <span class="number">6</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> value%i == <span class="number">0</span> || value%(i+<span class="number">2</span>) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>基于以上程序写测试，可以像下面这样写：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestPrime</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> primeTests = []<span class="keyword">struct</span>&#123;</span><br><span class="line">        input <span class="type">int</span></span><br><span class="line">        expected <span class="type">bool</span></span><br><span class="line">    &#125; &#123;</span><br><span class="line">        &#123;<span class="number">1</span>, <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123;<span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123;<span class="number">5</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">        &#123;<span class="number">6</span>, <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123;<span class="number">7</span>, <span class="literal">false</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> primeTests &#123;</span><br><span class="line">        actual := isPrime(tt.input)</span><br><span class="line">        <span class="keyword">if</span> actual != tt.expected &#123;</span><br><span class="line">            t.Errorf(<span class="string">&quot;%d %v %v&quot;</span>, tt.input, actual, tt.expected)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>上面测试中最后一个测试用例是错误的，所以执行测试时会返回测试不通过的结果，当然错误的原因并不是程序的问题，而是测试用例的错误。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--- FAIL: TestPrime (0.00s)</span><br><span class="line">    main_test.go:22: 7 <span class="literal">true</span> <span class="literal">false</span></span><br><span class="line">FAIL</span><br><span class="line">FAIL    <span class="built_in">test</span>    0.006s</span><br><span class="line">FAIL</span><br></pre></td></tr></table></figure><br>因为测试中使用的是<code>t.Errorf</code>，其中某个情况测试失败，并不会中止测试，其他测试用例会继续执行下去。在单元测试中，传递给测试函数的参数是<code>*testing.T</code>类型，它用于管理测试状态并支持格式化测试日志（测试日志会在执行测试的过程中不断累积，并在测试完成时输出到标准输出上）。</p>
<p>在一次测试中，测试函数执行结束返回，或者测试函数调用FailNow、 Fatal、Fatalf、SkipNow、Skip和Skipf中的任意一个时，这次测试即宣告结束。与Parallel方法一样，以上提到的这些方法只能在运行测试函数的goroutine中调用。而其他打印的方法，比如Log以及Error的变种，则可以在多个goroutine中同时调用。</p>
<p>下面总结了测试的几个方法的含义，当某个测试用例测试失败时这些方法的后续动作分别如下。</p>
<ul>
<li>Fail：记录失败信息，然后继续执行后续用例。</li>
<li>FailNow：记录失败信息，所有测试中断。</li>
<li>SkipNow：不会记录失败的用例信息，然后中止测试。</li>
<li>Skip：记录失败信息，中断后续测试。</li>
<li>Skipf：相比前者多了一个格式化输出。</li>
<li>Log：输出错误信息，在单元测试中，默认不输出成功的用例信息，不会中断后续测试。</li>
<li>Logf：输出格式化的信息，不中断后续测试。</li>
<li>Error：相当于Log + Fail，不会中断后续测试。</li>
<li>Errorf：相当于Logf + Fail，同上。</li>
<li>Fatal：相当于Log + FailNow，会中断后续测试。</li>
<li>Fatalf：相当于Logf + FailNow，同上。</li>
</ul>
<p>在默认情况下，单元测试成功时，它们打印的信息不会输出，可以通过加上<code>-v</code>选项，输出这些信息。但对于基准测试，它们总是会被输出。</p>
<p>例如，调用<code>*T</code>或<code>*B</code>的Skip方法，跳过该测试或基准测试：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestPrime</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> testing.Short() &#123;</span><br><span class="line">        t.Skip(<span class="string">&quot;skipping test in short mode.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>3，模拟测试</strong></p>
<p>单元测试的原则，就是你所测试的函数方法不受所依赖环境的影响，比如网络访问等。但有时候运行单元测试的时候需要联网，而由于开发环境限制，不能联网，此时就需要模拟网络访问来完成测试了。</p>
<p>针对模拟网络访问，标准库提供了一个httptest包，可以模拟HTTP的网络调用，下面举个例子了解如何使用。</p>
<p>首先创建一个处理HTTP请求的函数，并注册路由：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Routes</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/sendjson&quot;</span>, SendJson)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendJson</span><span class="params">(rw http.ResponseWriter,r *http.Request)</span></span> &#123;</span><br><span class="line">    u := <span class="keyword">struct</span> &#123;</span><br><span class="line">        Name <span class="type">string</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        Name: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    rw.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    rw.WriteHeader(http.StatusOK)</span><br><span class="line">    json.NewEncoder(rw).Encode(u)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>非常简单，这里是一个/sendjson API，当访问这个API时，会返回一个JSON字符串。现在对这个API服务进行测试，但是又不能时时刻刻都启动着服务，所以这里就用到了外部终端对API的网络访问请求：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http/httptest&quot;</span></span><br><span class="line">    <span class="string">&quot;test/common&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    common.Routes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSendJSoN</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    req, err := http.NewRequest(http.MethodGet, <span class="string">&quot;/sendjson&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        t.Fatal(<span class="string">&quot;创建Request失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    rw := httptest.NewRecorder()</span><br><span class="line">    http.DefaultServeMux.ServeHTTP(rw, req)</span><br><span class="line">    log.Println(<span class="string">&quot;code:&quot;</span>, rw.Code)</span><br><span class="line">    log.Println(<span class="string">&quot;body:&quot;</span>, rw.Body.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>运行这个单元测试，就可以看到程序自动访问/sendjson API的结果，并且没有启动任何HTTP服务就达到了目的。这里主要利用<code>httptest.NewRecorder()</code>创建一个<code>http.ResponseWriter</code>，模拟了真实服务器端的响应，这种响应是通过调用<code>http.DefaultServeMux.ServeHTTP</code>方法触发的。</p>
<p>还有一个模拟调用的方式，是真的在测试机上模拟一个服务器，然后进行调用测试：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mockServer</span><span class="params">()</span></span> *httptest.Server &#123;</span><br><span class="line">    <span class="comment">//API调用处理函数</span></span><br><span class="line">    sendJson := <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        u := <span class="keyword">struct</span> &#123;</span><br><span class="line">            Name <span class="type">string</span></span><br><span class="line">        &#125;&#123;</span><br><span class="line">            Name: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        rw.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">        rw.WriteHeader(http.StatusOK)</span><br><span class="line">        json.NewEncoder(rw).Encode(u)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//适配器转换</span></span><br><span class="line">    <span class="keyword">return</span> httptest.NewServer(http.HandlerFunc(sendJson))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSendJson</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建一个模拟的服务器</span></span><br><span class="line">    server := mockServer()</span><br><span class="line">    <span class="keyword">defer</span> server.Close()</span><br><span class="line">    <span class="comment">//Get请求发往模拟服务器的地址</span></span><br><span class="line">    resq, err := http.Get(server.URL)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        t.Fatal(<span class="string">&quot;创建Get失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> resq.Body.Close()</span><br><span class="line">    </span><br><span class="line">    log.Println(<span class="string">&quot;code:&quot;</span>, resq.StatusCode)</span><br><span class="line">    json, err := io.ReadAll(resq.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(<span class="string">&quot;body:%s\n&quot;</span>, json)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>模拟服务器的创建使用的是<code>httptest.NewServer</code>函数，它接收一个<code>http.Handler</code>处理API请求的接口。代码示例中使用了Hander的适配器模式，<code>http.HandlerFunc</code>是一个函数类型，实现了<code>http.Handler</code>接口，注意这里是强制类型转换，不是函数的调用。</p>
<p>这个创建的模拟服务器，监听的是本机IP 127.0.0.1，端口是随机的。接着发送Get请求的时候，不再发往/sendjson，而是模拟服务器的地址<code>server.URL</code>，剩下的就和访问正常的URL一样了，打印出结果即可。</p>
<p><strong>4，测试覆盖率</strong></p>
<p>尽可能模拟更多的场景来测试代码的不同情况，但是有时候的确也有忘记测试的代码，这时候就需要测试覆盖率作为参考了。</p>
<p>由单元测试的代码，触发运行的被测试代码的代码行数占所有代码行数的比例，被称为测试覆盖率，代码覆盖率不一定完全精准，但是可以作为参考，可以有助于测量和预计的覆盖率之间的差距，<code>go test</code>工具就提供了这样一个度量测试覆盖率的能力。</p>
<p>依旧使用前面素数判断的程序（注意把7对应的值修改为正确的，不然无法通过测试），现在使用<code>go test</code>工具运行单元测试，和前几次不一样的是，要显示测试覆盖率，所以要多加一个参数<code>-coverprofile</code>，完整的命令为：<code>go test -v -coverprofile=c.out</code>，<code>-coverprofile</code>是指定生成的覆盖率文件，例子中是<code>c.out</code>，这个文件稍后会用到。现在看终端输出，已经有了一个覆盖率：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go <span class="built_in">test</span> -v -coverprofile=c.out</span></span><br><span class="line">=== RUN   TestPrime</span><br><span class="line">--- PASS: TestPrime (0.00s)</span><br><span class="line">PASS</span><br><span class="line">coverage: 66.7% of statements</span><br><span class="line">ok      test    0.005s</span><br></pre></td></tr></table></figure><br>现在测试覆盖率为66.7%，还没有到100%，那么看看还有哪些代码没有被测试到。这就需要刚刚生成的测试覆盖率文件<code>c.out</code>生成测试覆盖率报告了。生成报告使用Go提供的工具<code>go tool cover -html=c.out -o=tag.html</code>，即可生成一个名字为tag.html的HTML格式的测试覆盖率报告（如图14-1所示），这里有详细的信息告诉我们哪一行代码测试到了，哪一行代码没有测试到。</p>
<blockquote>
<p>图14-1 显示为测试的语句</p>
</blockquote>
<img src="/2021/09/18/%E7%AC%AC14%E7%AB%A0-%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B5%8B%E8%AF%95/1.png" class="">
<p>可以看到，标记为绿色的代码行已经被测试了，标记为红色的还没有测试到，现在根据没有测试到的代码逻辑，完善单元测试代码即可（例如增加一个测试实例，输入为25即可100%覆盖isPrime函数）。</p>
<h2 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h2><p>基准测试（benchmarking）是一种测量和评估软件性能指标的活动。在某个时候通过基准测试建立一个已知的性能水平（称为基准线），当系统的软硬件环境发生变化之后再进行一次基准测试以确定那些变化对性能的影响，这是基准测试最常见的用途。其他用途包括测定某种负载水平下的性能极限、管理系统或环境的变化、发现可能导致性能问题的条件等。</p>
<p>在<code>_test.go</code>结尾的测试文件中，如下形式的函数（基准测试的函数必须以Benchmark开头，必须是可导出的）：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkXxx</span><span class="params">(*testing.B)</span></span></span><br></pre></td></tr></table></figure><br>被认为是基准测试，通过<code>go test</code>命令，加上<code>-bench</code>选项来执行。多个基准测试按照顺序运行。</p>
<p>基准测试函数样例如下所示：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkHello</span><span class="params">(b *testing.B)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        fmt.Sprintf(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>基准函数会运行目标代码b.N次。在基准执行期间，会调整b.N直到基准测试函数持续足够长的时间，输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -bench=. -run=none</span><br><span class="line">BenchmarkSprintf-4</span><br><span class="line">10000000</span><br><span class="line">148ns/op</span><br><span class="line">PASS</span><br><span class="line">ok</span><br><span class="line">github.com/... ../14/bench_test</span><br><span class="line">2.249s</span><br></pre></td></tr></table></figure><br>意味着循环执行了10000000次，每次循环花费148ns。</p>
<p>运行基准测试也要使用<code>go test</code>命令，不过要加上<code>-bench=</code>标记，它接受一个表达式作为参数，匹配基准测试的函数，<code>.</code>表示运行所有基准测试。</p>
<p>因为默认情况gotest会运行单元测试，为了防止单元测试的输出影响查看基准测试的结果，可以使用<code>-run=</code>匹配一个不存在的单元测试方法，过滤掉单元测试的输出，这里使用none，因为基本上不会创建这个名字的单元测试方法。</p>
<p>下面着重解释一下输出的结果，函数后面的-4表示运行时对应的GOMAXPROCS的值；接着的10000000表示运行for循环的次数，也就是调用被测试代码的次数，最后的148ns/op表示每次需要花费148ns。</p>
<p>以上测试时间默认是1s，也就是1s的时间调用一千万次，每次调用花费148ns。如果想让测试运行的时间更长，可以通过-benchtime指定，比如3s：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go <span class="built_in">test</span> -bench=. -benchtime=3s -run=none</span></span><br></pre></td></tr></table></figure><br>当然，在一般情况下，加长测试时间，只会导致测试的次数变多，但是最终的性能结果并没有太大变化。建议测试时间不要超过3s，当然，具体情况具体分析。</p>
<p>如果在运行前基准测试需要一些耗时的配置，则可以先重置定时器（例如避免for循环之前的初始化代码的干扰）：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBigLen</span><span class="params">(b*testing.B)</span></span>&#123;</span><br><span class="line">    ... ... <span class="comment">// 初始化代码</span></span><br><span class="line">    b.ResetTimer()<span class="comment">//</span></span><br><span class="line">    ... ... <span class="comment">// 通常是一个for循环</span></span><br></pre></td></tr></table></figure><br>如果基准测试需要在并行设置中测试性能，则可以使用RunParallel辅助函数，这样的基准测试一般与<code>go test -cpu</code>标志一起使用：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkTemplateParallel</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    templ := template.Must(template.New(<span class="string">&quot;test&quot;</span>).Parse(<span class="string">&quot;Hello,&#123;&#123;.&#125;&#125;!&quot;</span>))</span><br><span class="line">    b.RunParallel(<span class="function"><span class="keyword">func</span><span class="params">(pb *testing.PB)</span></span> &#123;</span><br><span class="line">        <span class="comment">//每个goroutine有属于自己的bytes.Buffer</span></span><br><span class="line">        <span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">        <span class="keyword">for</span> pb.Next() &#123;</span><br><span class="line">            <span class="comment">//所有goroutine一起，循环一共执行b.N次（N指默认的CPU核心数）</span></span><br><span class="line">            buf.Reset()</span><br><span class="line">            templ.Execute(&amp;buf, <span class="string">&quot;World&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>基准测试是一种测试代码性能的方法。想要测试解决同一问题的不同方案的性能，以及查看哪种解决方案的性能更好，基准测试就会很有用。基准测试也可以用来识别某段代码的CPU或者内存效率问题，而这段代码的效率可能会严重影响整个应用程序的性能。许多开发人员会用基准测试来测试不同的并发模式，或者用基准测试来辅助配置工作池的数量，以保证能最大化系统的吞吐量。</p>
<p><strong>1，性能对比</strong></p>
<p>上面那个基准测试的例子，其实是一个int类型转为string类型的例子，标准库里还有几种方法，看一下哪种性能更加高效，具体代码如下：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSprintf</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    num := <span class="number">10</span></span><br><span class="line">    b.ResetTimer()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        fmt.Sprintf(<span class="string">&quot;%d&quot;</span>, num)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkFormat</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    num := <span class="type">int64</span>(<span class="number">10</span>)</span><br><span class="line">    b.ResetTimer()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        strconv.FormatInt(num, <span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkItoa</span><span class="params">(b*testing.B)</span></span>&#123;</span><br><span class="line">    num:=<span class="number">10</span></span><br><span class="line">    b.ResetTimer()</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;b.N;i++&#123;</span><br><span class="line">        strconv.Itoa(num)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在第一次调用时，b.N的值为1。需要注意的是，一定要将所有要进行基准测试的代码都放到循环里，并且循环要使用b.N的值，否则测试的结果是不可靠的。<br>执行基准测试：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -bench=. -run=none</span><br><span class="line">goos:linux</span><br><span class="line">goarch:amd64</span><br><span class="line">pkg:github.com/izuolan/example/chapter13/bench_test</span><br><span class="line">BenchmarkSprintf-4</span><br><span class="line">10000000</span><br><span class="line">155ns/op</span><br><span class="line">BenchmarkFormat-4</span><br><span class="line">300000000</span><br><span class="line">6.99ns/op</span><br><span class="line">BenchmarkItoa-4</span><br><span class="line">200000000</span><br><span class="line">9.79ns/op</span><br><span class="line">PASS</span><br><span class="line">ok github.com/izuolan/example/chapter13/bench_test 7.243s</span><br></pre></td></tr></table></figure><br>从结果上看strconv.FormatInt函数是最快的，其次是strconv.Itoa，而fmt.Sprintf最慢，前两个函数性能相对于最后一个超过了3倍。</p>
<p>为了进一步分析三个函数快慢的根源，可以通过-benchmem分析内存的使用情况。 -benchmem可以提供每次操作分配内存的次数，以及每次操作分配的字节（B）数。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -bench=. -benchmem -run=none</span><br><span class="line">goos:linux</span><br><span class="line">goarch:amd64</span><br><span class="line"></span><br><span class="line">pkg:github.com/izuolan/example/chapter13/bench_test</span><br><span class="line">BenchmarkSprintf-4</span><br><span class="line">10000000</span><br><span class="line">150ns/op</span><br><span class="line">16B/op</span><br><span class="line">2allocs/op</span><br><span class="line">BenchmarkFormat-4</span><br><span class="line">300000000</span><br><span class="line">5.01ns/op</span><br><span class="line">2B/op</span><br><span class="line">1allocs/op</span><br><span class="line">BenchmarkItoa-4</span><br><span class="line">200000000</span><br><span class="line">7.00ns/op</span><br><span class="line">2B/op</span><br><span class="line">1allocs/op</span><br><span class="line">PASS</span><br><span class="line">okgithub.com/izuolan/example/chapter13/bench_test 5.811s</span><br></pre></td></tr></table></figure><br>这次输出的结果会多出两组新的数值：一组数值的单位是B/op，另一组的单位是 allocs/op，其中单位为allocs/op的值表示每次操作从堆上分配内存的次数。可以看到Sprintf函数每次操作都会从堆上分配两个值，而另外两个函数每次操作只需要分配一个值。单位为B/op的值表示每次操作分配的B数，你可以看到Sprintf函数两次分配总共消耗了16B的内存，而另外两个函数操作消耗2B内存。从这个数据就知道它为什么这么慢了，内存分配与占用都太高。<br>在运行单元测试和基准测试时，还有很多选项可以用。建议读者查看一遍所有选项（下一节会介绍一部分），以便在编写自己的包和工程时，充分利用测试框架。Go社区希望包的作者在正式发布包的时候提供足够的测试<br>在代码开发中，对于要求性能的地方，编写基准测试非常重要，这有助于开发出性能更好的代码。不过性能、可用性、复用性等也要有一个相对的取舍，不能为了追求性能而过度优化。</p>
<p>2.pprof</p>
<p>在之前的例子中，只能查看函数的执行时间，如果想进一步分析函数的具体执行状况可以配合其他选项使用。上面曾经使用到一些基准测试的选项，其中常用的测试选项如下。<br>· -bench regexp：regexp可以是任何正则表达式，表示需要运行的基准测试函数。一般可以使用’-bench.来执行当前目录下所有的基准测试。<br>m631S<br>·-benchmen：在输出内容中包含基准测试的内存分配统计信息。<br>· -benchtimet：t表示执行单个测试函数的累积耗时上限，默认是1s。<br>·-cpuprofile out：输出cpu profile到指定的路径，可以使用pprof查看。<br>·-memprofle out：输出内存profile到指定路径，可以使用pprof查看。<br>执行一个基准测试时，可以指定相关的选项，例如以下这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ gotest-bench.--benchmem -cpuprofile cpu.prof</span><br><span class="line">goos:linux</span><br><span class="line"></span><br><span class="line">goarch: amd64</span><br><span class="line">pkg:github.com/izuolan/example/chapter13/bench_test</span><br><span class="line">BenchmarkSprintf-4</span><br><span class="line">10000000</span><br><span class="line">176ns/op</span><br><span class="line">16B/op</span><br><span class="line">2allocs/op</span><br><span class="line">BenchmarkFormat-4</span><br><span class="line">300008080</span><br><span class="line">4.90ns/op</span><br><span class="line">0B/op</span><br><span class="line">0allocs/op</span><br><span class="line">BenchmarkItoa-4</span><br><span class="line">200008000</span><br><span class="line">6.95ns/op</span><br><span class="line">0B/op</span><br><span class="line">0allocs/op</span><br><span class="line">PASS</span><br><span class="line">okgithub.com/izuolan/example/chapter13/bench_test 6.213s</span><br><span class="line">$ 1s</span><br><span class="line">bench_test.test cpu.prof str_test.go</span><br></pre></td></tr></table></figure><br>生成两个文件是无法直接查看的，需要使用工具去解析。<br>这就需要本节的主角pprof登场了，这是一个Go语言提供的性能分析工具，可以分析cpuprofile、 memory profile、 heap profile. block profile等信息。<br>在上面的基准测试中，已经知道怎样生成cpu.prof文件了，然后可以利用go tool pprof工具来查看：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof bench_test.test cpu.prof</span><br><span class="line">File:bench_test.test</span><br><span class="line">Type:cpu</span><br><span class="line">Time:Nov 14,2017 at 7:27pm(HKT)</span><br><span class="line">Duration: 6.21s, Total samples = 6.e5s(97.49%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure><br>这时会进入一个可交互环境，输入help可以查看所有的交互命令，现在可以使用top10来查看测试过程中最耗CPU资源的函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(pprof)top10</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> 4840ms,80.00% of 6050ms total</span><br><span class="line">Dropped 39 nodes(cum&lt;=30.25ms)</span><br><span class="line">Showing top 10 nodes out of 39</span><br><span class="line">flat flat% <span class="built_in">sum</span>%</span><br><span class="line">cum cum%</span><br><span class="line">2160ms 35.70%35.70%2160ms35.70%</span><br><span class="line">strconv.FormatInt /.../go/src/strconv/ itoa.go</span><br><span class="line">840ms13.88% 49.59%1760ms 29.09%strconv.Itoa /.../go/src/strconv/itoa.go 710ms11.74%61.32%1950ms 32.23%.../bench_test.BenchmarkFormat.../bench_</span><br><span class="line"><span class="built_in">test</span>/str_test.go</span><br><span class="line">350ms</span><br><span class="line">5.79%67.11%2110ms34.88%</span><br><span class="line">../bench_test.Benchmarkltoa .../bench_ <span class="built_in">test</span>/str_test.go</span><br><span class="line">200ms</span><br><span class="line">3.31%70.41%310ms</span><br><span class="line">5.12%runtime.mallocgc /.../go/src/runtime/</span><br><span class="line">malloc.go</span><br><span class="line">150ms</span><br><span class="line">2.48%72.89%340ms5.62%</span><br><span class="line"><span class="built_in">fmt</span>.(*<span class="built_in">fmt</span>).fmt_integer /.../go/src/fmt/ format.go</span><br><span class="line"></span><br><span class="line">110ms</span><br><span class="line">1.82%74.71% 320ms</span><br><span class="line">5.29%<span class="built_in">fmt</span>.(*pp).free /.../go/src/fmt/print.go</span><br><span class="line">110ms</span><br><span class="line">1.82%76.53%360ms</span><br><span class="line">5.95%runtime.slicebytetostring /.../go/src/</span><br><span class="line">runtime/string.go</span><br><span class="line">110ms</span><br><span class="line">1.82%78.35%190ms</span><br><span class="line">3.14%<span class="built_in">sync</span>.(*Pool).pin/.../go/src/sync/pool.go</span><br><span class="line">100ms</span><br><span class="line">1.65%80.00%100ms</span><br><span class="line">1.65% runtime.memmove /.../go/src/runtime/</span><br><span class="line">memmove_ amd64.s</span><br></pre></td></tr></table></figure><br>现在解释每一列的含义。在默认情况下，Go语言的运行时系统会以100Hz的频率对CPU使用情况进行取样。也就是说每s取样100次，即每10ms会取样一次（100Hz既足够产生有用的数据，又不至于让系统产生停顿）。实际上，这里所说的对CPU使用情况的取样就是对当前的goroutine的堆栈上的程序计数器的取样，由此就可以从样本记录中分析出哪些代码是计算时间最长或者说最耗CPU资源的部分了。<br>。第一列表示取样点落在该函数里的总数（不包括调用其他函数）。比如fmt/print 这个函数，总共执行时间为110ms，那么总的抽样点数为11次。<br>第二列表示落在该函数里取样点占总取样点的百分比，fmt/print这个函数占总共的1.82%。<br>·第三列表示的是前几行加起来的执行时间占总共执行时间的多少，top10命令的默认排序是按第一列（执行时间）排序。例如第三行的第三列表示的是：前三行函数的执行时间加起来占总共执行时间的61.32%。<br>第四列表示取样点落在该函数里和它直接调用、间接调用的函数里的总数。比如fmt/print这个函数，总时间为320ms，表示该函数的执行时间加上该函数调用的其他函数的执行时间共320ms。<br>·第五列表示第四列的时间占总时间的百分比。<br>从top10的输出里至少可以知道每个函数的执行时间占比以及每个函数的调用栈的执行时间的占比。如果某个函数自身的执行时间过长，那说明这个函数是否有逻辑错误，是否需要拆分。如果某个函数的调用栈的执行时间过长，是否是因为调用了过多的不需要的函数。<br>有了初步认识之后，可以使用图形化的界面来分析整个函数的执行过程。在这之前，需要安装Graphviz，具体安装方法见软件官网，安装好之后在pprof交互模式下使用web命令查看。<br>top和web等命令也可以指定函数名称，只查看关注的函数的执行情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(pprof) top BenchmarkFormat</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> 195ems,32.23% of 6050ms total</span><br><span class="line"></span><br><span class="line">flat flat% <span class="built_in">sum</span>%</span><br><span class="line">cum cum%</span><br><span class="line">1240ms20.50%20.50% 1240ms20.50%strconv.FormatInt /.../go/src/strconv/itoa.go 710ms11.74%32.23% 1950ms 32.23%.../bench_test.BenchmarkFormat /.../bench_</span><br><span class="line"><span class="built_in">test</span>/str_test.go</span><br><span class="line">0</span><br><span class="line">0% 32.23%1950ms 32.23%</span><br><span class="line">testing.(*B).launch /.../go/src/testing/ benchmark.go</span><br><span class="line">日</span><br><span class="line">0%32.23% 1950ms32.23%</span><br><span class="line">testing.(*B).runN/.../go/src/testing/ benchmark.go</span><br></pre></td></tr></table></figure><br>更进一步而言，可以通过list命令查看具体是哪一行在耗时，如图14-2所示。</p>
<blockquote>
<p>图14-2函数执行状况</p>
</blockquote>
<p>这样就能知道函数的整体执行情况了，第一列表示该行的执行时间，第二列表示该行的总执行时间。</p>
<h1 id="本章小结"><a href="#本章小结" class="headerlink" title="本章小结"></a>本章小结</h1><p>通过本章内容的学习，了解了最基本的Go语言安全方面的概念，主要掌握了如何测试一个Go语言程序，Go语言提供了必要的测试工具，例如gotest用来运行测试（测试文件总是以_test.go作为文件名的结尾）。表组测试是利用一个测试函数测试多组值的好办法，基准测试可以探查代码性能，从而优化Go语言程序。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Go%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%98%E6%8A%80%E5%B7%A7/" rel="tag"># Go语言编程入门与实战技巧</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/18/%E7%AC%AC13%E7%AB%A0-%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/" rel="next" title="第13章 文件处理">
                <i class="fa fa-chevron-left"></i> 第13章 文件处理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/18/%E7%AC%AC15%E7%AB%A0-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="prev" title="第15章 内存管理">
                第15章 内存管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="CheBin"/>
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">参与开源才是出路</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%20%7C%7C%20archive">
                
                    <span class="site-state-item-count">1127</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/%20%7C%7C%20th">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/%20%7C%7C%20tags">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">84</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2024/06/21/context/" title="context" target="_blank">context</a>
                  </li>
                
                  <li>
                    <a href="/2024/05/30/%E7%AC%AC21%E7%AB%A0-%E5%9F%BA%E4%BA%8EZinx%E6%A1%86%E6%9E%B6%E7%9A%84%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/" title="第21章 基于Zinx框架的应用项目案例" target="_blank">第21章 基于Zinx框架的应用项目案例</a>
                  </li>
                
                  <li>
                    <a href="/2024/05/30/%E7%AC%AC20%E7%AB%A0-Zinx%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86%E5%8F%8A%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE/" title="第20章 Zinx连接管理及属性设置" target="_blank">第20章 Zinx连接管理及属性设置</a>
                  </li>
                
                  <li>
                    <a href="/2024/05/30/%E7%AC%AC19%E7%AB%A0-Zinx%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8C%E4%BB%BB%E5%8A%A1%E5%B7%A5%E4%BD%9C%E6%B1%A0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="第19章 Zinx消息队列和任务工作池设计与实现" target="_blank">第19章 Zinx消息队列和任务工作池设计与实现</a>
                  </li>
                
                  <li>
                    <a href="/2024/05/30/%E7%AC%AC18%E7%AB%A0-Zinx%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA/" title="第18章 Zinx读写分离模型构建" target="_blank">第18章 Zinx读写分离模型构建</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8"><span class="nav-number">1.</span> <span class="nav-text">安全</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">2.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">2.1.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-number">2.2.</span> <span class="nav-text">基准测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">本章小结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:41</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
